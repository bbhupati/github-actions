name: Build and Deploy

on:
  push:
    branches:
      - "*"

jobs:
  set-environment:
    runs-on: ubuntu-latest
    outputs:
      environment_type: ${{ steps.set_env.outputs.environment }}
    steps:
      - name: Set environment based on branch name
        id: set_env
        run: |
          if [[ ${{ github.ref }} == "refs/heads/dev" ]]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          elif [[ ${{ github.ref }} == "refs/heads/qa" ]]; then
            echo "environment=qa" >> $GITHUB_OUTPUT
          elif [[ ${{ github.ref }} == "refs/heads/master" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=unknown environment" >> $GITHUB_OUTPUT
          fi

  npm-build-test:
    runs-on: ubuntu-latest
    needs: [set-environment]
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Read environment file and set environment variables
        run: |
          echo "env is ${{ needs.set-environment.outputs.environment_type }}"
          ENV_FILE=".github/workflows/${{ needs.set-environment.outputs.environment }}-vars.env"
          cat $ENV_FILE >> $GITHUB_ENV
          echo "Loaded $ENV_FILE into environment variables"
      - name: Display loaded environment variables
        run: |
          echo "API_URL=$API_URL"
          echo "DATABASE_URL=$DATABASE_URL"

  docker-build-push:
    runs-on: ubuntu-latest
    needs: [set-environment]
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Read environment file and set environment variables
        run: |
          ENV_FILE=".github/workflows/${{ needs.set-environment.outputs.environment }}-vars.env"
          cat $ENV_FILE >> $GITHUB_ENV
          echo "Loaded $ENV_FILE into environment variables"
      - name: Display loaded environment variables
        run: |
          echo "API_URL=$API_URL"
          echo "DATABASE_URL=$DATABASE_URL"

  update-app-service-config:
    runs-on: ubuntu-latest
    needs: [set-environment]
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Read environment file and set environment variables
        run: |
          ENV_FILE=".github/workflows/${{ needs.set-environment.outputs.environment }}-vars.env"
          cat $ENV_FILE >> $GITHUB_ENV
          echo "Loaded $ENV_FILE into environment variables"
      - name: Display loaded environment variables
        run: |
          echo "API_URL=$API_URL"
          echo "DATABASE_URL=$DATABASE_URL"


# on:
#   push:
#     branches: ['dev']

# jobs:
#   job1:
#     runs-on: ubuntu-latest
#     # Map a step output to a job output
#     outputs:
#       output1: ${{ steps.step1.outputs.test }}
#       output2: ${{ steps.step2.outputs.test }}
#     steps:
#       - id: step1
#         run: echo "test=$(date +"%d-%m-%Y")-asdfads223" >> $GITHUB_OUTPUT
#       - id: step2
#         run: echo "test=world" >> $GITHUB_OUTPUT
#   job2:
#     runs-on: ubuntu-latest
#     needs: job1
#     steps:
#       - run: echo ${{needs.job1.outputs.output1}} ${{needs.job1.outputs.output2}}
